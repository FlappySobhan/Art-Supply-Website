{% extends "../base.html" %}

{% block title %}{{product.name}}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row m-0">
        <div id="carouselControls" class="carousel slide my-2 col-md-6" data-bs-ride="true">
            {% if product.picture2 %}
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#carouselControls" data-bs-slide-to="0" class="active"
                    aria-current="true" aria-label="Slide 1"></button>
                <button type="button" data-bs-target="#carouselControls" data-bs-slide-to="1"
                    aria-label="Slide 2"></button>
            </div>
            {% endif %}
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img src="{{product.picture1.url}}" class="d-block w-100" alt="{{product.name}} picture 1">
                </div>
                {% if product.picture2 %}
                <div class="carousel-item">
                    <img src="{{product.picture2.url}}" class="d-block w-100" alt="{{product.name}} picture 2">
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselControls" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselControls" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
            {% else %}
        </div>
        {% endif %}
    </div>
    <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center border-bottom">
            <h1 class=" pb-3">{{product.name}}</h1>
            {% if user.is_authenticated %}
                {% csrf_token %}
                <div>
                    {% if is_in_wishlist %}
                    <!-- wishlist button -->
                    <button id="wishlist" class="btn btn-danger float-end" data-bs-toggle="tooltip"
                    title="Remove from wishlist">
                    <i class="bi bi-heart-fill"></i>
                    {% else %}
                    <button id="wishlist" class="btn btn-outline-danger float-end" data-bs-toggle="tooltip"
                    title="Add to wishlist">
                        <i class="bi bi-heart"></i>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        <p class="mt-4 lead"><small>{{product.descriptions}}</small></p>
        <div class="mt-4 pt-2 d-flex justify-content-between">
            {% if product.category %}
            <div class="text-start">
                <a href="{% url 'products-list' %}?category={{product.category}}" 
                class="badge text-decoration-none btn-dark">{{product.category}}</a>
            </div>
            {% endif %}
            {% if product.stock < 3 %}
            <div class="text-end">
                {% if product.stock == 0 %}
                <span class="badge bg-danger">Out of stock</span>
                {% else %}
                <span class="badge bg-danger">Only {{product.stock}} left in stock</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="mt-2 d-flex justify-content-between align-items-center border-top">
            <div class="d-flex">
                {% if product.discount %}
                <span class="text-muted text-decoration-line-through">${{ product.price }}</span>
                {% endif %}
                <p class="display-6 font-monospace fw-bold">${{ product.final_price }}</p>
            </div>
            <div class="d-flex mb-2">
                {% if product.stock > 0 %}
                <form action="" method="POST">
                    {% csrf_token %}
                    <div class="row g-3">
                        {% if product.stock > 1 %}
                        <div class="col-4"></div>
                        <div class="col-3">
                            <input class="form-control" type="number"
                             name="quantity" value="1" min="1">
                        </div>
                        <button class="btn btn-primary col-5" type="submit">Add to cart</button>
                        {% else %}
                        <button class="btn btn-primary" type="submit">Add to cart</button>
                        {% endif %}
                    </div>
                </form>
                {% else %}
                <button class="btn btn-primary" type="button" disabled>Add to cart</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

{% endblock %}
{% block scripts %}
    <script>      
        $(function() {
            $('[data-bs-toggle="tooltip"]').tooltip()
        })

        let wishlist = document.getElementById('wishlist');
        wishlist.addEventListener('click', function() {
            let url = '{% url "wishlist" product.id %}';
            let token = 'Bearer '+localStorage.getItem('token');
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                }
            }).then(response => {
                if (response.status == '200') {
                    if (wishlist.classList.contains('btn-outline-danger')) {
                        wishlist.classList.remove('btn-outline-danger');
                        wishlist.classList.add('btn-danger');
                        wishlist.title = 'Remove from wishlist';
                        wishlist.innerHTML = '<i class="bi bi-heart-fill"></i>';
                        $(this).attr('data-bs-original-title', 'Remove from wishlist');
                    } else {
                        wishlist.classList.remove('btn-danger');
                        wishlist.classList.add('btn-outline-danger');
                        wishlist.title = 'Add to wishlist';
                        wishlist.innerHTML = '<i class="bi bi-heart"></i>';
                        $(this).attr('data-bs-original-title', 'Add to wishlist');
                    }
                }
            })
        })
    </script>  

{% endblock %}
